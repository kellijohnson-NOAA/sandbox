# Combined formatting workflow for C++ and R code
# 
# This workflow runs clang-format on C++ code and devtools::document() + styler::style_pkg()
# on R code when a PR is opened or updated.
#
# Fork Handling:
# - If the PR is from a fork, the workflow adds a comment with instructions on how to
#   format code locally instead of attempting to push changes (which would fail on forks).
# - If the PR is NOT from a fork, the workflow creates a PR with formatting changes
#   targeting the original feature branch.
#
# Workflow Trigger:
# - This workflow runs when a pull request is opened or updated (synchronized) 
#   targeting the 'main' or 'dev' branches.
# - The formatting is applied to the source (head) branch of the PR, NOT to main or dev.
# - If formatting changes are needed, a new PR will be created targeting the 
#   original feature branch (for non-forks).
# - Example: If PR from 'feature-branch' -> 'dev' needs formatting, a new PR 
#   'format-code-feature-branch' -> 'feature-branch' will be created.
# - The formatting PR must be merged into the feature branch before the original
#   PR can be merged into main/dev.
#
# Clang-Format Version:
# - Using clang-format version 18.0.0 for consistency.
# - Clang-format 17 had known bugs, so we explicitly set the version.
#
# More details:
# - Clang-Format: https://clang.llvm.org/docs/ClangFormat.html
# - Formatting in VS Code: https://code.visualstudio.com/docs/editor/codebasics#_formatting

name: pr-format

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main
      - dev
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

# Cancel runs happening simultaneously on the same branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format-code:
    name: Format C++ and R code
    runs-on: ubuntu-latest
    steps:
      # Check if this PR is from a fork
      - name: Check if fork
        id: check_fork
        run: |
          if [ "${{ github.event.pull_request.head.repo.fork }}" == "true" ]; then
            echo "is_fork=true" >> "$GITHUB_OUTPUT"
            echo "This PR is from a fork"
          else
            echo "is_fork=false" >> "$GITHUB_OUTPUT"
            echo "This PR is from the same repository"
          fi
      
      # Checkout the source branch (head ref) of the Pull Request where
      # formatting will be applied
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.PAT }}

      # Install R dependencies for styling and documentation
      - name: Install curl dependency
        run: |
          sudo apt-get update
          sudo apt-get install libcurl4-openssl-dev

      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Setup R dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            remotes
            styler
            roxygen2
            usethis

      # Run R formatting and documentation
      - name: Style R code
        run: |
          results <- styler::style_pkg()
          if (any(is.na(results[["changed"]]))) {
            stop("styler threw an error")
          }
        shell: Rscript {0}

      - name: Document R code
        run: Rscript -e 'roxygen2::roxygenise()'

      - name: Style R code again
        run: | 
          results <- styler::style_pkg()
          if (any(is.na(results[["changed"]]))) {
            stop("styler threw an error")
          }
        shell: Rscript {0}

      - name: Document R code again
        run: Rscript -e 'roxygen2::roxygenise()'
        
      - name: Style DESCRIPTION file
        run: Rscript -e 'usethis::use_tidy_description()'

      - name: Clean up .github artifacts
        run: |
          cd .github
          rm -f *.rds *.Rds R-version

      # Run clang-format on C++ code
      # Format hpp and cpp files under inst/include, src/, and tests/gtest
      # We use Google style to format code.
      - name: Run clang-format
        uses: DoozyX/clang-format-lint-action@v0.20
        with:
          source: './inst/include'
          extensions: 'hpp, cpp'
          style: "{BasedOnStyle: Google, SortIncludes: false}"
          inplace: True

      # Check if there are any changes after formatting
      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet || echo "has_changes=true" >> "$GITHUB_OUTPUT"
          if [ -z "$(git status --porcelain)" ]; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No formatting changes needed"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Formatting changes detected"
          fi

      # If this is a fork AND there are changes, add a comment with instructions
      - name: Comment on fork PR with formatting instructions
        if: steps.check_fork.outputs.is_fork == 'true' && steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const instructions = `## ðŸŽ¨ Code Formatting Required
            
            Your pull request requires code formatting changes. Since this PR is from a fork, the automated formatting workflow cannot push changes directly to your branch.
            
            Please format your code locally by following these steps:
            
            ### Format C++ Code
            
            1. Install clang-format version 18.0.0
            2. Run the following command from the repository root:
               \`\`\`bash
               clang-format -i --style="{BasedOnStyle: Google, SortIncludes: false}" $(find ./inst/include ./src ./tests/gtest -name "*.hpp" -o -name "*.cpp")
               \`\`\`
            
            ### Format R Code
            
            Run the following commands in R from the repository root:
            
            \`\`\`r
            # Style R code
            styler::style_pkg()
            
            # Update documentation
            roxygen2::roxygenise()
            
            # Style R code again (to catch any changes from documentation)
            styler::style_pkg()
            
            # Update documentation again
            roxygen2::roxygenise()
            
            # Style DESCRIPTION file
            usethis::use_tidy_description()
            \`\`\`
            
            ### After Formatting
            
            1. Commit the formatting changes:
               \`\`\`bash
               git add .
               git commit -m "style: format C++ and R code"
               \`\`\`
            
            2. Push to your fork:
               \`\`\`bash
               git push
               \`\`\`
            
            The formatting checks will run again automatically after you push the changes.
            `;
            
            // Check if we've already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('ðŸŽ¨ Code Formatting Required') || comment.body.includes('âœ… Code Formatting Complete'))
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: instructions
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: instructions
              });
            }

      # If this is a fork AND NO changes are needed, update comment to indicate completion
      - name: Update fork PR comment to indicate no formatting changes needed
        if: steps.check_fork.outputs.is_fork == 'true' && steps.check_changes.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const successMessage = `## âœ… Code Formatting Complete
            
            All code formatting requirements have been met. No further formatting changes are needed for this pull request.
            
            The automated formatting workflow has checked:
            - **C++ code**: Verified with clang-format (Google style)
            - **R code**: Verified with styler and roxygen2
            - **DESCRIPTION file**: Verified with usethis::use_tidy_description()
            
            Your code is properly formatted and ready for review! ðŸŽ‰
            `;
            
            // Check if we've already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('ðŸŽ¨ Code Formatting Required') || comment.body.includes('âœ… Code Formatting Complete'))
            );
            
            if (botComment) {
              // Update existing comment with success message
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: successMessage
              });
            }
            // If no previous comment exists and no changes needed, don't create a comment


      # If NOT a fork AND there are changes, create a PR with formatting changes
      - name: Create Pull Request with formatting changes
        if: steps.check_fork.outputs.is_fork == 'false' && steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: 'style: format C++ and R code'
          token: ${{ secrets.PAT }}
          branch: format-code-${{ github.head_ref }}
          base: ${{ github.head_ref }}
          title: 'Chore: format feature branch'
          reviewers: ${{ github.event.pull_request.user.login }}
          body: |
            Auto-generated by [pr-format.yml][1]
            
            This PR applies formatting to the feature branch `${{ github.head_ref }}`:
            - **C++ formatting**: Applied clang-format (Google style) to `.hpp` and `.cpp` files
            - **R formatting**: Applied `styler::style_pkg()` and updated documentation with `roxygen2::roxygenise()`
            
            **Action required**: Merge this PR into `${{ github.head_ref }}` before merging the original PR into `${{ github.base_ref }}`.
            
            [1]: https://github.com/${{ github.repository }}/blob/main/.github/workflows/pr-format.yml

      # Success message when no changes are needed
      - name: No formatting changes needed
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "âœ… All code is properly formatted. No changes needed."