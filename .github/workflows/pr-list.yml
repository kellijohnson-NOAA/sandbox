# Adds a comment to a newly opened PR letting reviewers know what should be
# included in their review.
name: Add a comment with reviewer checklist when PR opened

on:
  pull_request_target:
    types: [opened]

permissions:
  pull-requests: write

jobs:
  pr-checklist:
    runs-on: ubuntu-latest
    name: pr-checklist
    steps:
      - name: 'Update PR Description'
        uses: actions/github-script@v8
        if: github.event_name == 'pull_request'
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const checklist_marker = '# Instructions for code reviewer';
            const checklist = '\n\n___\n\n' +
            '# Instructions for code reviewer\n\n' +
            ':wave:Hello reviewer:wave:, thank you for taking the time to review this PR!\n\n' +
            '- Please use this checklist during your review, checking off items that you have verified are complete but feel free to skip over items that are not relevant!\n' +
            '- See the [GitHub documentation for how to comment on a PR](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/reviewing-changes-in-pull-requests/commenting-on-a-pull-request) to indicate where you have questions or changes are needed before approving the PR.\n' +
            '- Please use standard [conventional messages](https://www.conventionalcommits.org/) for both commit messages and comments\n' +
            '- PR reviews are a great way to learn so feel free to share your tips and tricks. However, when suggesting changes to the PR that are optional please include `nit:` (for nitpicking) as the comment type. For example, `nit:` I prefer using a `data.frame()` instead of a `matrix` because ...\n' +
            '- Engage with the developer. Make it clear when the PR is approved by selecting the approved status, and potentially commenting on the PR with something like `This PR is now ready to be merged.`\n\n' +
            '## Checklist\n\n' +
            '- [ ] The PR requests the appropriate base branch (dev for features and main for hot fixes)\n' +
            '- [ ] The code is well-designed.\n' +
            '- [ ] The code is designed well for both users and developers\n' +
            '- [ ] Code coverage remains high' +
            '- [ ] Comments are clear, useful, and explain why instead of what\n' +
            '- [ ] Code is appropriately documented (doxygen and roxygen)\n';
            
            const current_body = pullRequest.body || '';
            
            // Only append checklist if it doesn't already exist
            if (!current_body.includes(checklist_marker)) {
              const new_body = current_body + checklist;
              
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                body: new_body
              });
            } else {
              console.log('Checklist already exists in PR description, skipping update');
            }
