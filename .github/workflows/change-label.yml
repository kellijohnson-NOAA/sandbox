name: Change Issue Label on PR Merge

on:
  pull_request_target:
    types: [closed]
    branches:
      - dev

jobs:
  update-issue-labels:
    # Only update the labels if the PR is merged to dev and abort if just closed
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Get issues
        uses: mondeja/pr-linked-issues-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update referenced issues
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumbers = JSON.parse('${{ steps.get-issues.outputs.issues }}');
            for (const issue_number of issueNumbers) {
              try {
                // Get current labels
                const { data: issue } = await github.rest.issues.get({
                  ...context.repo,
                  issue_number
                });
                const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);
                if (!labels.includes('status: in dev')) {
                  labels.push('status: in dev');
                }
                const newLabels = labels.filter(l => l !== 'status: in progress');
                await github.rest.issues.update({
                  ...context.repo,
                  issue_number,
                  labels: newLabels
                });
              } catch (err) {
                console.log(`Error updating labels for issue #${issue_number}:`, err);
              }
            }