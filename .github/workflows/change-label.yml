name: Change Issue Label on PR Merge

on:
  pull_request_target:
    types: [closed]
    branches:
      - dev

jobs:
  update-issue-labels:
    # Only update the labels if the PR is merged to dev and abort if just closed
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Find and update referenced issues
        uses: actions/github-script@v7
        with:
          script: |
            const closingKeywords = [
              'close', 'closes', 'closed',
              'fix', 'fixes', 'fixed',
              'resolve', 'resolves', 'resolved'
            ];
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            const regex = new RegExp(`(?:${closingKeywords.join('|')})\\s+#(\\d+)`, 'gi');
            let match;
            const issueNumbers = new Set();

            // Find issues referenced by closing keywords in PR body
            while ((match = regex.exec(prBody)) !== null) {
              issueNumbers.add(Number(match[1]));
            }

            // Find issues referenced by closing keywords in commit messages
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                ...context.repo,
                pull_number: pr.number,
                per_page: 100
              }
            );
            for (const commit of commits) {
              const messages = [commit.commit.message];
              for (const message of messages) {
                let m;
                while ((m = regex.exec(message)) !== null) {
                  issueNumbers.add(Number(m[1]));
                }
              }
            }

            // Find issues linked in the "Development" section (timeline events)
            const timeline = await github.paginate(
              github.rest.issues.listEventsForTimeline,
              {
                ...context.repo,
                issue_number: pr.number,
                per_page: 100
              }
            );
            for (const event of timeline) {
              if (
                event.event === 'connected' &&
                event.source &&
                event.source.type === 'issue' &&
                event.source.issue &&
                event.source.issue.number
              ) {
                issueNumbers.add(event.source.issue.number);
              }
            }

            // Update labels for each referenced issue
            for (const issue_number of issueNumbers) {
              // Get current labels
              const { data: issue } = await github.rest.issues.get({
                ...context.repo,
                issue_number
              });
              const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);
              // Add "status: in dev" if not present
              if (!labels.includes('status: in dev')) {
                labels.push('status: in dev');
              }
              // Remove "status: in progress" if present
              const newLabels = labels.filter(l => l !== 'status: in progress');
              await github.rest.issues.update({
                ...context.repo,
                issue_number,
                labels: newLabels
              });
            }
