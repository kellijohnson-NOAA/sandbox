name: Change Issue Label on PR Merge

on:
  pull_request_target:
    types: [closed]
    branches:
      - dev

jobs:
  update-issue-labels:
    # Only update the labels if the PR is merged to dev and abort if just closed
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: read
    
    steps:
      - name: Find and update referenced issues
        uses: actions/github-script@v7
        with:
          script: |
            const closingKeywords = [
              'close', 'closes', 'closed',
              'fix', 'fixes', 'fixed',
              'resolve', 'resolves', 'resolved',
              ':wrench:'
            ];
            // Contain all of the information about the PR in pr object
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            // Search for any closing keyword followed by any number of spaces #[0-9]+
            // Cannot list multiple issue numbers behind a closing keyword
            const regex = new RegExp(`(?:${closingKeywords.join('|')})\\s+#(\\d+)`, 'gi');
            let match;
            const issueNumbers = new Set();

            // Find issues referenced by closing keywords in PR body
            while ((match = regex.exec(prBody)) !== null) {
              console.log(`Found issue in PR body: #${match[1]}`);
              issueNumbers.add(Number(match[1]));
            }

            // Find issues referenced by closing keywords in commit messages
            const commits = await github.paginate(
              github.rest.pulls.listCommits,
              {
                ...context.repo,
                pull_number: pr.number,
                per_page: 100
              }
            );
            for (const commit of commits) {
              const messages = [commit.commit.message];
              for (const message of messages) {
                let m;
                while ((m = regex.exec(message)) !== null) {
                  console.log(`Found issue in commit message: #${m[1]} (commit: ${commit.sha})`);
                  issueNumbers.add(Number(m[1]));
                }
              }
            }

            console.log('All referenced issue numbers:', Array.from(issueNumbers));

            // Update labels for each referenced issue
            for (const issue_number of issueNumbers) {
              try {
                // Get current labels
                const { data: issue } = await github.rest.issues.get({
                  ...context.repo,
                  issue_number
                });
                const labels = issue.labels.map(l => typeof l === 'string' ? l : l.name);
                // Add "status: in dev" if not present
                if (!labels.includes('status: in dev')) {
                  labels.push('status: in dev');
                }
                // Remove "status: in progress" if present
                const newLabels = labels.filter(l => l !== 'status: in progress');
                await github.rest.issues.update({
                  ...context.repo,
                  issue_number,
                  labels: newLabels
                });
                console.log(`Successfully updated labels for issue #${issue_number}`);
              } catch (err) {
                console.log(`Error updating labels for issue #${issue_number}:`, err);
              }
            }
            if (issueNumbers.size === 0) {
              console.log('No referenced issues found to update.');
            }
